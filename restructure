#!/usr/bin/perl -n

s/^\s*|\s*$//g;

$nonempty = length $_;
$indent = '  ' x length($1) if s/^\s*=(=*)\s*(.*?)\s*=\1.*$/\2./g;

s/\[\[([^\]\|]+)(\|([^\]\|]+)){2,}\]\]//g;
s/\[\[([^\]\|]+)\|([^\]]+)\]\]/\2 [\1]/g;
s/\[\[([a-z ]+)\]\]/[\1]/g;
s/\[\[([^\]]+)\]\]/[\1]/g;

s/''+((?:[^']|'[^'])+)''+/\1/g;

s/\{\{[^}]+\}\}//g;
s/&lt;ref[^&]*&gt;.*?&lt;\/ref&gt;//g;
s/&lt;.*?&gt;//g;
s/&[^;]*;//g;

s/^\s*\*\s*/- /;
s/^/$indent/;
s/\s*$//;

print $_, "\n" if !$nonempty || length $_;
